<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canteen Staff - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#EA580C' },
                        'dark-bg': '#18171c',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .order-column { min-height: 80vh; }
        #qr-reader-container { width: 100%; max-width: 500px; }
        .tab-button.active {
            border-bottom-color: #EA580C;
            color: #EA580C;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-bg text-gray-800 dark:text-gray-200">

    <div id="app-content" class="container mx-auto p-4 hidden">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <div class="flex items-center space-x-4">
                <h1 class="text-3xl font-bold">Staff Dashboard</h1>
                <div id="connection-status" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></div>
                    <span class="text-sm font-medium text-gray-500">Connecting...</span>
                </div>
            </div>
            <button id="scan-qr-btn" class="w-full sm:w-auto bg-primary text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center space-x-2 shadow-lg hover:bg-primary-dark transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span>Scan to Verify Payment</span>
            </button>
        </header>

        <!-- Tabs -->
        <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button class="tab-button active font-semibold whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 dark:text-gray-400" data-tab="orders">Live Orders</button>
                <button class="tab-button font-semibold whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 dark:text-gray-400" data-tab="menu">Menu Management</button>
                <button class="tab-button font-semibold whitespace-nowrap py-4 px-1 border-b-2 border-transparent text-gray-500 dark:text-gray-400" data-tab="reports">Reports</button>
            </nav>
        </div>

        <!-- Orders Tab -->
        <div id="orders-tab" class="tab-content active">
            <div id="orders-board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white dark:bg-gray-800/50 rounded-lg shadow-md">
                    <h2 class="text-lg font-bold p-4 border-b border-gray-200 dark:border-gray-700">Pending Payment</h2>
                    <div id="pending-orders-col" class="p-4 space-y-4 order-column"></div>
                </div>
                <div class="bg-white dark:bg-gray-800/50 rounded-lg shadow-md">
                    <h2 class="text-lg font-bold p-4 border-b border-gray-200 dark:border-gray-700">Ready for Pickup</h2>
                    <div id="ready-orders-col" class="p-4 space-y-4 order-column"></div>
                </div>
                <div class="bg-white dark:bg-gray-800/50 rounded-lg shadow-md">
                    <h2 class="text-lg font-bold p-4 border-b border-gray-200 dark:border-gray-700">Completed Today</h2>
                    <div id="completed-orders-col" class="p-4 space-y-4 order-column"></div>
                </div>
            </div>
        </div>

        <!-- Other Tabs -->
        <div id="menu-tab" class="tab-content">...</div>
        <div id="reports-tab" class="tab-content">...</div>
    </div>

    <div id="loading-auth" class="flex items-center justify-center h-screen text-center p-4">...</div>

    <!-- QR Scanner Modal -->
    <div id="qr-scanner-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">...</div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js'

        const SUPABASE_URL = "https://aieuyzdfsuczuidhrgot.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZXV5emRmc3VjenVpZGhyZ290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0NzA3NDEsImV4cCI6MjA3NTA0Njc0MX0.mpGcYxjoPXBD2G4eo_GFJqbxsH4UVCxR_-KVDoQMWxY";


        let supabase = null;
        let orders = [];
        let menuItems = [];
        let html5QrCode = null;

        // --- Sound Effects Setup ---
        let synth = null;
        const playNewOrderSound = () => {
            if (!synth) synth = new Tone.Synth().toDestination();
            synth.triggerAttackRelease("C5", "8n");
        }
        const playPaymentConfirmedSound = () => {
            if (!synth) synth = new Tone.Synth().toDestination();
            const now = Tone.now();
            synth.triggerAttackRelease("C5", "8n", now);
            synth.triggerAttackRelease("E5", "8n", now + 0.1);
            synth.triggerAttackRelease("G5", "8n", now + 0.2);
        }

        // --- UI Element References ---
        // ... (all unchanged)

        // --- All render functions and DB update functions are unchanged ---

        async function initializeStaffView() {
            try {
                // ... (Supabase initialization and security check)

                await fetchAndRenderAllData();

                supabase.channel('public-db-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => {
                        console.log('Real-time order change received!', payload);
                        const { eventType, new: newOrderData, old: oldOrderData } = payload;

                        // --- SOUND EFFECT LOGIC ---
                        if (eventType === 'INSERT') {
                            playNewOrderSound();
                        } else if (eventType === 'UPDATE') {
                            // Play sound if status changed from unpaid to paid
                            if (oldOrderData.payment_status === 'unpaid' && newOrderData.payment_status === 'paid') {
                                playPaymentConfirmedSound();
                            }
                        }

                        let orderId = eventType === 'DELETE' ? oldOrderData.id : newOrderData.id;
                        const existingOrderIndex = orders.findIndex(o => o.id === orderId);

                        if (eventType === 'INSERT') { if (existingOrderIndex === -1) orders.push(newOrderData); }
                        else if (eventType === 'UPDATE') { if (existingOrderIndex > -1) orders[existingOrderIndex] = newOrderData; }
                        else if (eventType === 'DELETE') { if (existingOrderIndex > -1) orders.splice(existingOrderIndex, 1); }
                        renderAllOrders();

                    }).subscribe(/* ... */);

                // ... (other subscriptions and event listeners)

            } catch(error) {
                console.error("Initialization failed:", error);
                loadingAuth.innerHTML = `<p class="text-red-500 font-semibold">Error verifying access: ${error.message}</p>`;
            }
        }

        document.addEventListener('DOMContentLoaded', initializeStaffView);
    </script>
</body>
</html>

